<body>
<style>
    #target {
        background-color: magenta;
        position: absolute;
        z-index: -1;
        width: 100px;
        height: 100px;
    }
    #touchpad {
        border: 1px solid blue;
    }
    #deadzone, #control {
        position: absolute;
        display: none;
        border-radius: 50%;
        border: 1px solid green;
    }
    #control {
        border-color: red;
    }
</style>
<script src="./touchpad.js" type="module"></script>
<touchpad-component id='touchpad' analogmax="1">
    <div id="deadzone"></div>
    <div id="control"></div>
    <p id="log"></p>
    <div id="target"></div>
</touchpad-component>
<script>
    window.addEventListener('load', () => {
        const touchpadElement = document.querySelector('#touchpad')
        const deadzoneElement = document.querySelector('#deadzone')
        const controlElement = document.querySelector('#control')
        const logElement = document.querySelector('#log')
        const targetElement = document.querySelector('#target')
        let pointerId = NaN
        let targetX = 0
        let targetY = 0
        let _analogX = 0
        let _analogY = 0

        const moveTarget = () => {
            targetX = targetX + _analogX * 4
            targetY = targetY + _analogY * 4

            if (targetX < 0)
                targetX = 0
            else if (targetX + targetElement.clientWidth > window.innerWidth)
                targetX = window.innerWidth - targetElement.clientWidth

            if (targetY < 0)
                targetY = 0
            else if (targetY + targetElement.clientHeight > window.innerHeight)
                targetY = window.innerHeight - targetElement.clientHeight

            targetElement.style.left = targetX
            targetElement.style.top = targetY
        }
        let intervalId = NaN

        touchpadElement.addEventListener('pointerdown', event => {
            if (pointerId === pointerId) return

            pointerId = event.pointerId

            const analogData = touchpadElement.getAnalogData(pointerId)

            if (!analogData) return

            deadzoneElement.style.display = 'block'
            controlElement.style.display = 'block'

            deadzoneElement.style.width = touchpadElement.deadzoneRadius * 2 + 'px'
            deadzoneElement.style.height = touchpadElement.deadzoneRadius * 2 + 'px'
            controlElement.style.width = touchpadElement.controlRadius * 2 + 'px'
            controlElement.style.height = touchpadElement.controlRadius * 2 + 'px'

            const { deadzoneX, deadzoneY, controlX, controlY } = analogData
            const { x, y } = touchpadElement.getBoundingClientRect()

            deadzoneElement.style.left = x + deadzoneX - touchpadElement.deadzoneRadius
            deadzoneElement.style.top = y + deadzoneY - touchpadElement.deadzoneRadius
            controlElement.style.left = x + controlX - touchpadElement.controlRadius
            controlElement.style.top = y + controlY - touchpadElement.controlRadius
        })

        touchpadElement.addEventListener('pointermove', event => {
            if (pointerId !== event.pointerId) return

            const analogData = touchpadElement.getAnalogData(pointerId)

            if (!analogData) return

            pointerId = event.pointerId
            const { deadzoneX, deadzoneY, controlX, controlY, analogX, analogY } = analogData

            _analogX = analogX
            _analogY = analogY

            const { x, y } = touchpadElement.getBoundingClientRect()

            deadzoneElement.style.left = x + deadzoneX - touchpadElement.deadzoneRadius
            deadzoneElement.style.top = y + deadzoneY - touchpadElement.deadzoneRadius
            controlElement.style.left = x + controlX - touchpadElement.controlRadius
            controlElement.style.top = y + controlY - touchpadElement.controlRadius

            logElement.textContent = `${analogX}, ${analogY}`

            if (!intervalId) 
                intervalId = setInterval(moveTarget, 1000 / 60)
        })

        touchpadElement.addEventListener('pointerup', event => {
            pointerId = NaN
            clearInterval(intervalId)
            intervalId = NaN

            deadzoneElement.style.display = 'none'
            controlElement.style.display = 'none'
            logElement.textContent = '0, 0'
        })
    })
</script>
</body>
